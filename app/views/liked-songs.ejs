<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" type="" href="/css/style.css">
  <link rel="stylesheet" type="" href="/css/playlist.css">
  <link rel="stylesheet" type="" href="/css/loading.css">
  <script src="/js/pending-changes.js"></script>
  <title>Liked Songs</title>
</head>

<body class="lava">
  <%- include("./components/modals/loading-overlay") %>
  <%- include("./components/modals/create-playlist-modal") %>

  <%- include("./components/header") %>

    <main class="flex">
      <div class="window flex" id="playlist-header">
        <img width="300px" src="/media/liked.png" alt="Liked Songs">
        <div class="flex" id="playlist-info">
          <h1>Liked Songs</h1>
          <p>Your collection of favorite tracks</p>
          <div class="flex" id="playlist-meta">
            <span>
              <%= tracks.length %> tracks
            </span>
          </div>
        </div>
      </div>

      <div class="window flex" id="stats">
        <h2>Stats go here</h2>
      </div>

      <div class="window" id="tracks">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h2>Tracks</h2>
          <form method="POST" action="/liked-songs/refresh" style="margin: 0;" onsubmit="showLoadingOverlay()">
            <button type="submit" class="refresh-btn">Refresh from Spotify</button>
          </form>
        </div>

        <% if (!tracks || tracks.length === 0) { %>
          <div class="empty-state">
            <p>No liked songs loaded. Click "Refresh from Spotify" to load your liked songs.</p>
          </div>
        <% } else { %>
        <div id="filter-section">
          <h2>Filters</h2>
          <div class="filter-inputs">
            <div class="filter-group">
              <label for="artist-filter">Artist:</label>
              <input type="text" id="artist-filter" placeholder='Use "quotes" for exact match'>
            </div>
            <div class="filter-group">
              <label for="album-filter">Album:</label>
              <input type="text" id="album-filter" placeholder='Use "quotes" for exact match'>
            </div>
            <div class="filter-group">
              <label for="genre-filter">Genre:</label>
              <input type="text" id="genre-filter" placeholder='Use "quotes" for exact match'>
            </div>
            <div class="filter-group">
              <label for="track-filter">Track Name:</label>
              <input type="text" id="track-filter" placeholder='Use "quotes" for exact match'>
            </div>
            <button id="clear-filters" class="clear-btn">Clear Filters</button>
          </div>
          <div id="filter-chips"></div>
          <div id="filter-count"></div>
          <button id="save-filtered-playlist" class="save-playlist-btn">Save Filtered Results as New Playlist</button>
        </div>
        
        <h2>Tracks</h2>
        <ul class="track-list">
          <% for (const item of tracks) { %>
            <% if (item.track) { %>
              <!-- <a target="_blank" href="https://open.spotify.com/track/<%= item.track.id %>"> -->
                <li class="track-item">
                  <div class="track flex">
                    <% if (item.track.album && item.track.album.images && item.track.album.images.length> 0) { %>
                      <img width="64px" height="64px" src="<%= item.track.album.images[0].url %>"
                        alt="<%= item.track.name %>">
                      <% } else { %>
                        <img width="64px" height="64px" src="/media/missing.jpg" alt=":(">
                        <% } %>
                          <div class="track-info">
                            <h3>
                              <%= item.track.name %>
                            </h3>
                            <p>
                              <%= item.track.artists.map(a=> a.name).join(", ") %>
                            </p>
                            <div class="genre-container" data-track-id="<%= item.track.id %>">
                              <% const trackGenres=genres[item.track.id]; %>
                              <div class="genre-display">
                                <% if (trackGenres && trackGenres.trim()) { %>
                                  <div class="genre-tags">
                                    <% trackGenres.split(", ").filter(g => g.trim()).forEach(genre=> { %>
                                      <span class="genre-tag" data-genre="<%= genre %>">
                                        <%= genre %>
                                      </span>
                                      <% }); %>
                                  </div>
                                <% } else { %>
                                  <div class="genre-tags">
                                    <span class="no-genres">No genres</span>
                                  </div>
                                <% } %>
                                <button class="edit-genres-btn" onclick="editGenres(event, '<%= item.track.id %>')">Edit</button>
                              </div>
                              <div class="genre-edit hidden">
                                <div class="genre-tags-editable"></div>
                                <input type="text" class="genre-input" placeholder="Add genre..." onkeypress="handleGenreInput(event, '<%= item.track.id %>')">
                                <div class="genre-actions">
                                  <button class="save-btn" onclick="saveGenres(event, '<%= item.track.id %>')">Save</button>
                                  <button class="cancel-btn" onclick="cancelEdit(event, '<%= item.track.id %>')">Cancel</button>
                                </div>
                              </div>
                            </div>
                          </div>
                          <div class="track-album">
                            <p>
                              <%= item.track.album ? item.track.album.name : "Unknown Album" %>
                            </p>
                          </div>
                          <div class="track-duration">
                            <% const minutes=Math.floor((item.track.duration_ms || 0) / 60000); const
                              seconds=Math.floor(((item.track.duration_ms || 0) % 60000) / 1000); const
                              formatted=`${minutes}:${seconds.toString().padStart(2, '0' )}`; %>
                              <span>
                                <%= formatted %>
                              </span>
                          </div>
                  </div>
                </li>
              <!-- </a> -->
              <% } %>
                <% } %>
        </ul>
        <% } %>
      </div>

    </main>

    <%- include("./components/footer") %>

    <script src="/js/filters.js"></script>
    <script src="/js/playlist-creator.js"></script>
    <script>
      // Hide loading overlay when page loads (handles back button navigation)
      window.addEventListener('pageshow', function(event) {
        document.getElementById('loading-overlay').classList.add('hidden');
      });

      // Show loading overlay function
      function showLoadingOverlay() {
        document.getElementById('loading-overlay').classList.remove('hidden');
      }

      // Data from server
      const tracks = <%- JSON.stringify(tracks) %>;
      const genres = <%- JSON.stringify(genres) %>;
      const userId = '<%= userId %>';

      // Initialize filters
      initializeFilters(tracks, genres);
      
      // Initialize playlist creator
      initializePlaylistCreator(userId);

      // Genre editing functions
      function editGenres(event, trackId) {
        event.preventDefault();
        event.stopPropagation();
        
        const container = document.querySelector(`.genre-container[data-track-id="${trackId}"]`);
        const display = container.querySelector('.genre-display');
        const edit = container.querySelector('.genre-edit');
        
        // Get current genres
        const currentGenres = [];
        container.querySelectorAll('.genre-tag[data-genre]').forEach(tag => {
          currentGenres.push(tag.dataset.genre);
        });
        
        // Populate editable tags
        const editableContainer = edit.querySelector('.genre-tags-editable');
        editableContainer.innerHTML = '';
        currentGenres.forEach(genre => {
          const tag = document.createElement('span');
          tag.className = 'genre-tag-edit';
          tag.innerHTML = `${genre} <button onclick="removeGenreTag(event, '${trackId}', '${genre}')">×</button>`;
          editableContainer.appendChild(tag);
        });
        
        // Show edit mode
        display.classList.add('hidden');
        edit.classList.remove('hidden');
      }

      function cancelEdit(event, trackId) {
        event.preventDefault();
        event.stopPropagation();
        
        const container = document.querySelector(`.genre-container[data-track-id="${trackId}"]`);
        const display = container.querySelector('.genre-display');
        const edit = container.querySelector('.genre-edit');
        
        edit.classList.add('hidden');
        display.classList.remove('hidden');
        edit.querySelector('.genre-input').value = '';
      }

      function removeGenreTag(event, trackId, genre) {
        event.preventDefault();
        event.stopPropagation();
        event.target.parentElement.remove();
      }

      function handleGenreInput(event, trackId) {
        if (event.key === 'Enter') {
          event.preventDefault();
          const input = event.target;
          const genre = input.value.trim();
          
          if (genre) {
            const container = document.querySelector(`.genre-container[data-track-id="${trackId}"]`);
            const editableContainer = container.querySelector('.genre-tags-editable');
            
            // Check if genre already exists
            const exists = Array.from(editableContainer.querySelectorAll('.genre-tag-edit')).some(tag => 
              tag.textContent.includes(genre)
            );
            
            if (!exists) {
              const tag = document.createElement('span');
              tag.className = 'genre-tag-edit';
              tag.innerHTML = `${genre} <button onclick="removeGenreTag(event, '${trackId}', '${genre}')">×</button>`;
              editableContainer.appendChild(tag);
            }
            
            input.value = '';
          }
        }
      }

      async function saveGenres(event, trackId) {
        event.preventDefault();
        event.stopPropagation();
        
        const container = document.querySelector(`.genre-container[data-track-id="${trackId}"]`);
        const editableContainer = container.querySelector('.genre-tags-editable');
        
        // Get new genres list
        const newGenres = [];
        editableContainer.querySelectorAll('.genre-tag-edit').forEach(tag => {
          const genre = tag.textContent.replace('×', '').trim();
          newGenres.push(genre);
        });
        
        // Get original genres
        const originalGenres = genres[trackId] ? genres[trackId].split(', ').filter(g => g.trim()) : [];
        
        // Find genres to add and remove
        const toAdd = newGenres.filter(g => !originalGenres.includes(g));
        const toRemove = originalGenres.filter(g => !newGenres.includes(g));
        
        try {
          // Remove genres
          for (const genre of toRemove) {
            await fetch(`/api/tracks/${trackId}/genres/${encodeURIComponent(genre)}`, {
              method: 'DELETE'
            });
          }
          
          // Add genres
          for (const genre of toAdd) {
            await fetch(`/api/tracks/${trackId}/genres`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ genre })
            });
          }
          
          // Update local genres object
          genres[trackId] = newGenres.join(', ');
          
          // Update display
          const display = container.querySelector('.genre-display');
          const genreTags = display.querySelector('.genre-tags');
          genreTags.innerHTML = '';
          
          if (newGenres.length > 0) {
            newGenres.forEach(genre => {
              const tag = document.createElement('span');
              tag.className = 'genre-tag';
              tag.dataset.genre = genre;
              tag.textContent = genre;
              genreTags.appendChild(tag);
            });
          } else {
            genreTags.innerHTML = '<span class="no-genres">No genres</span>';
          }
          
          // Hide edit mode
          cancelEdit(event, trackId);
          
        } catch (error) {
          console.error('Failed to save genres:', error);
          alert('Failed to save genres. Please try again.');
        }
      }

    </script>
</body>

</html>
