<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" type="" href="/css/style.css">
  <link rel="stylesheet" type="" href="/css/playlist.css">
  <link rel="stylesheet" type="" href="/css/loading.css">
  <title>
    <%= playlist.name %>
  </title>
</head>

<body class="lava">
  <!-- Loading overlay -->
  <div id="loading-overlay" class="loading-overlay hidden">
    <div style="text-align: center;">
      <div class="loading-spinner"></div>
      <div class="loading-text">Loading...</div>
    </div>
  </div>

  <%- include("./components/header") %>

    <main class="flex">
      <div class="window flex" id="playlist-header">
        <% if (playlist.images && playlist.images.length> 0 && playlist.images[0].url) { %>
          <img width="300px" src="<%= playlist.images[0].url %>" alt="<%= playlist.name %>">
          <% } else { %>
            <img width="300px" src="/media/missing.jpg" alt=":(">
            <% } %>
              <div class="flex" id="playlist-info">
                <h1>
                  <%= playlist.name %>
                </h1>
                <% if (playlist.description) { %>
                  <p>
                    <%= playlist.description %>
                  </p>
                  <% } %>
                    <div class="flex" id="playlist-meta">
                      <span>
                        <%= playlist.owner.display_name %>
                      </span>
                      <span>•</span>
                      <span>
                        <%= tracks.length %> tracks
                      </span>
                    </div>
              </div>
      </div>

      <div class="window flex" id="stats">
        <h2>Stats go here</h2>
      </div>

      <div class="window" id="tracks">
        <div id="filter-section">
          <h2>Filters</h2>
          <div class="filter-inputs">
            <div class="filter-group">
              <label for="artist-filter">Artist:</label>
              <input type="text" id="artist-filter" placeholder='Use "quotes" for exact match'>
            </div>
            <div class="filter-group">
              <label for="album-filter">Album:</label>
              <input type="text" id="album-filter" placeholder='Use "quotes" for exact match'>
            </div>
            <div class="filter-group">
              <label for="genre-filter">Genre:</label>
              <input type="text" id="genre-filter" placeholder='Use "quotes" for exact match'>
            </div>
            <div class="filter-group">
              <label for="track-filter">Track Name:</label>
              <input type="text" id="track-filter" placeholder='Use "quotes" for exact match'>
            </div>
            <button id="clear-filters" class="clear-btn">Clear Filters</button>
          </div>
          <div id="filter-chips"></div>
          <div id="filter-count"></div>
        </div>
        
        <h2>Tracks</h2>
        <ul class="track-list">
          <% for (const item of tracks) { %>
            <% if (item.track) { %>
              <a target="_blank" href="https://open.spotify.com/track/ <%= item.track.id %>">
                <li class="track-item">
                  <div class="track flex">
                    <% if (item.track.album && item.track.album.images && item.track.album.images.length> 0) { %>
                      <img width="64px" height="64px" src="<%= item.track.album.images[2].url %>"
                        alt="<%= item.track.name %>">
                      <% } else { %>
                        <img width="64px" height="64px" src="/media/missing.jpg" alt=":(">
                        <% } %>
                          <div class="track-info">
                            <h3>
                              <%= item.track.name %>
                            </h3>
                            <p>
                              <%= item.track.artists.map(a=> a.name).join(", ") %>
                            </p>
                            <% const trackGenres=genres[item.track.id]; if (trackGenres) { %>
                              <div class="genre-tags">
                                <% trackGenres.split(", ").slice(0, 3).forEach(genre=> { %>
                                  <span class="genre-tag">
                                    <%= genre %>
                                  </span>
                                  <% }); %>
                              </div>
                              <% } %>
                          </div>
                          <div class="track-album">
                            <p>
                              <%= item.track.album ? item.track.album.name : "Unknown Album" %>
                            </p>
                          </div>
                          <div class="track-duration">
                            <% const minutes=Math.floor((item.track.duration_ms || 0) / 60000); const
                              seconds=Math.floor(((item.track.duration_ms || 0) % 60000) / 1000); const
                              formatted=`${minutes}:${seconds.toString().padStart(2, '0' )}`; %>
                              <span>
                                <%= formatted %>
                              </span>
                          </div>
                  </div>
                </li>
              </a>
              <% } %>
                <% } %>
        </ul>
      </div>

    </main>

    <%- include("./components/footer") %>

    <script>
      // Hide loading overlay when page loads (handles back button navigation)
      window.addEventListener('pageshow', function(event) {
        document.getElementById('loading-overlay').classList.add('hidden');
      });

      // Filtering functionality
      const tracks = <%- JSON.stringify(tracks) %>;
      const genres = <%- JSON.stringify(genres) %>;
      
      let filters = {
        artists: [],
        albums: [],
        genres: [],
        trackName: ''
      };

      function parseFilterInput(input) {
        if (!input) return [];
        
        const terms = [];
        const regex = /"([^"]*)"|([^,]+)/g;
        let match;
        
        while ((match = regex.exec(input)) !== null) {
          const term = match[1] || match[2];
          if (term && term.trim()) {
            const trimmed = term.trim();
            terms.push({
              value: trimmed.toLowerCase(),
              exact: !!match[1]
            });
          }
        }
        
        return terms;
      }

      function matchesFilter(text, filterTerms) {
        if (filterTerms.length === 0) return true;
        const lowerText = text.toLowerCase();
        
        return filterTerms.some(term => {
          if (term.exact) {
            return lowerText === term.value;
          } else {
            return lowerText.includes(term.value);
          }
        });
      }

      function filterTracks() {
        const trackItems = document.querySelectorAll('.track-item');
        let visibleCount = 0;

        trackItems.forEach((item, index) => {
          const track = tracks[index];
          if (!track || !track.track) {
            item.style.display = 'none';
            return;
          }

          let showTrack = true;

          // Artist filter (OR within category)
          if (filters.artists.length > 0) {
            const artistNames = track.track.artists.map(a => a.name).join(' ');
            showTrack = showTrack && matchesFilter(artistNames, filters.artists);
          }

          // Album filter (OR within category)
          if (filters.albums.length > 0) {
            const albumName = track.track.album ? track.track.album.name : '';
            showTrack = showTrack && matchesFilter(albumName, filters.albums);
          }

          // Genre filter (OR within category)
          if (filters.genres.length > 0) {
            const trackGenres = genres[track.track.id] || '';
            showTrack = showTrack && matchesFilter(trackGenres, filters.genres);
          }

          // Track name filter
          if (filters.trackName.length > 0) {
            showTrack = showTrack && matchesFilter(track.track.name, filters.trackName);
          }

          item.style.display = showTrack ? '' : 'none';
          if (showTrack) visibleCount++;
        });

        updateFilterCount(visibleCount, tracks.length);
        updateFilterChips();
      }

      function updateFilterCount(visible, total) {
        const countEl = document.getElementById('filter-count');
        if (visible === total) {
          countEl.textContent = `Showing all ${total} tracks`;
        } else {
          countEl.textContent = `Showing ${visible} of ${total} tracks`;
        }
      }

      function updateFilterChips() {
        const chipsContainer = document.getElementById('filter-chips');
        chipsContainer.innerHTML = '';

        const allFilters = [
          ...filters.artists.map(a => ({ type: 'artist', value: a.value, exact: a.exact })),
          ...filters.albums.map(a => ({ type: 'album', value: a.value, exact: a.exact })),
          ...filters.genres.map(g => ({ type: 'genre', value: g.value, exact: g.exact })),
          ...filters.trackName.map(t => ({ type: 'track', value: t.value, exact: t.exact }))
        ];

        if (allFilters.length === 0) {
          chipsContainer.style.display = 'none';
          return;
        }

        chipsContainer.style.display = 'flex';
        allFilters.forEach(filter => {
          const chip = document.createElement('span');
          chip.className = 'filter-chip';
          const prefix = filter.exact ? '=' : '~';
          chip.textContent = `${filter.type} ${prefix} ${filter.value}`;
          
          const removeBtn = document.createElement('button');
          removeBtn.className = 'chip-remove';
          removeBtn.textContent = '×';
          removeBtn.onclick = () => removeFilter(filter.type, filter.value);
          
          chip.appendChild(removeBtn);
          chipsContainer.appendChild(chip);
        });
      }

      function removeFilter(type, value) {
        if (type === 'artist') {
          filters.artists = filters.artists.filter(a => a.value !== value);
          document.getElementById('artist-filter').value = rebuildFilterInput(filters.artists);
        } else if (type === 'album') {
          filters.albums = filters.albums.filter(a => a.value !== value);
          document.getElementById('album-filter').value = rebuildFilterInput(filters.albums);
        } else if (type === 'genre') {
          filters.genres = filters.genres.filter(g => g.value !== value);
          document.getElementById('genre-filter').value = rebuildFilterInput(filters.genres);
        } else if (type === 'track') {
          filters.trackName = filters.trackName.filter(t => t.value !== value);
          document.getElementById('track-filter').value = rebuildFilterInput(filters.trackName);
        }
        filterTracks();
      }

      function rebuildFilterInput(terms) {
        return terms.map(t => t.exact ? `"${t.value}"` : t.value).join(', ');
      }

      // Event listeners
      document.getElementById('artist-filter').addEventListener('input', (e) => {
        filters.artists = parseFilterInput(e.target.value);
        filterTracks();
      });

      document.getElementById('album-filter').addEventListener('input', (e) => {
        filters.albums = parseFilterInput(e.target.value);
        filterTracks();
      });

      document.getElementById('genre-filter').addEventListener('input', (e) => {
        filters.genres = parseFilterInput(e.target.value);
        filterTracks();
      });

      document.getElementById('track-filter').addEventListener('input', (e) => {
        filters.trackName = parseFilterInput(e.target.value);
        filterTracks();
      });

      document.getElementById('clear-filters').addEventListener('click', () => {
        filters = { artists: [], albums: [], genres: [], trackName: [] };
        document.getElementById('artist-filter').value = '';
        document.getElementById('album-filter').value = '';
        document.getElementById('genre-filter').value = '';
        document.getElementById('track-filter').value = '';
        filterTracks();
      });

      // Initialize
      filterTracks();
    </script>
</body>

</html>
